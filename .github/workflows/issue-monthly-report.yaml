name: Monthly Issue Report

on:
  schedule:
    # Run on the 1st of every month at 9:00 AM UTC
    - cron: "0 9 1 * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (print report without updating issue)'
        type: boolean
        default: false

jobs:
  generate-report:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.UI5_WEBCOMP_BOT_GH_TOKEN }}
          script: |
            const REPORT_ISSUE_NUMBER = 13080; // Monthly Issues Report tracking issue
            const isDryRun = context.eventName === 'workflow_dispatch' && ${{ inputs.dry_run || false }};

            // All TOPIC labels to track (team labels)
            const topics = [
              'TOPIC B',
              'TOPIC Core',
              'TOPIC P',
              'TOPIC RD',
              'TOPIC RL',
              'TOPIC SKR',
              'TOPIC TBL'
            ];

            // Helper to check if issue is a bug (by label OR issue type)
            const isBug = (issue) => {
              const labels = issue.labels.map(l => l.name.toLowerCase());
              const typeName = issue.type?.name?.toLowerCase() || '';
              return labels.includes('bug') || typeName === 'bug';
            };

            // Helper to check if issue is a feature request (by label OR issue type)
            const isFeatureRequest = (issue) => {
              const labels = issue.labels.map(l => l.name.toLowerCase());
              const typeName = issue.type?.name?.toLowerCase() || '';
              return labels.includes('feature request') || labels.includes('enhancement') || typeName === 'feature';
            };

            // Calculate date range for last month
            const now = new Date();
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
            const monthName = lastMonth.toLocaleString('en-US', { month: 'long', year: 'numeric' });

            const sinceDate = lastMonth.toISOString();
            const untilDate = lastMonthEnd.toISOString();

            console.log(`Generating report for ${monthName}`);
            console.log(`Date range: ${sinceDate} to ${untilDate}`);

            const results = [];

            for (const topic of topics) {
              // Get issues with this label using raw API to include 'type' field
              const allIssues = await github.paginate('GET /repos/{owner}/{repo}/issues', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: topic,
                state: 'all',
                since: sinceDate,
                per_page: 100
              });

              // Filter to issues created within the date range (exclude PRs)
              const opened = allIssues.filter(issue => {
                const created = new Date(issue.created_at);
                return created >= lastMonth && created <= lastMonthEnd && !issue.pull_request;
              });

              // Get closed issues - filter those closed in the period
              const closed = allIssues.filter(issue => {
                if (!issue.closed_at || issue.pull_request) return false;
                const closedDate = new Date(issue.closed_at);
                return closedDate >= lastMonth && closedDate <= lastMonthEnd;
              });

              // Split by type
              const openedBugs = opened.filter(isBug);
              const openedFRs = opened.filter(isFeatureRequest);
              const openedOther = opened.filter(i => !isBug(i) && !isFeatureRequest(i));

              const closedBugs = closed.filter(isBug);
              const closedFRs = closed.filter(isFeatureRequest);
              const closedOther = closed.filter(i => !isBug(i) && !isFeatureRequest(i));

              results.push({
                topic: topic,
                bugs: { opened: openedBugs.length, closed: closedBugs.length },
                frs: { opened: openedFRs.length, closed: closedFRs.length },
                other: { opened: openedOther.length, closed: closedOther.length }
              });
            }

            // Build markdown report
            let report = `## ${monthName} Issue Report\n\n`;

            // Bugs table
            report += `### Bugs\n\n`;
            report += `| Topic | Opened | Closed |\n`;
            report += `|-------|--------|--------|\n`;

            let totalBugsOpened = 0, totalBugsClosed = 0;
            for (const r of results) {
              report += `| ${r.topic} | ${r.bugs.opened} | ${r.bugs.closed} |\n`;
              totalBugsOpened += r.bugs.opened;
              totalBugsClosed += r.bugs.closed;
            }
            report += `| **Total** | **${totalBugsOpened}** | **${totalBugsClosed}** |\n\n`;

            // Feature Requests table
            report += `### Feature Requests\n\n`;
            report += `| Topic | Opened | Closed |\n`;
            report += `|-------|--------|--------|\n`;

            let totalFRsOpened = 0, totalFRsClosed = 0;
            for (const r of results) {
              report += `| ${r.topic} | ${r.frs.opened} | ${r.frs.closed} |\n`;
              totalFRsOpened += r.frs.opened;
              totalFRsClosed += r.frs.closed;
            }
            report += `| **Total** | **${totalFRsOpened}** | **${totalFRsClosed}** |\n\n`;

            // Summary
            report += `### Summary\n\n`;
            report += `| Type | Opened | Closed |\n`;
            report += `|------|--------|--------|\n`;
            report += `| Bugs | ${totalBugsOpened} | ${totalBugsClosed} |\n`;
            report += `| Feature Requests | ${totalFRsOpened} | ${totalFRsClosed} |\n`;
            const grandOpened = totalBugsOpened + totalFRsOpened;
            const grandClosed = totalBugsClosed + totalFRsClosed;
            report += `| **Total** | **${grandOpened}** | **${grandClosed}** |\n`;

            report += `\n_Report generated: ${now.toISOString()}_\n`;

            console.log('\n' + report);

            if (isDryRun) {
              console.log('\nDry run - not updating issue');
              return;
            }

            if (REPORT_ISSUE_NUMBER === 0) {
              console.log('\nREPORT_ISSUE_NUMBER not set - skipping issue update');
              console.log('Create a tracking issue and set REPORT_ISSUE_NUMBER to its number');
              return;
            }

            // Add report as a comment on the tracking issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: REPORT_ISSUE_NUMBER,
              body: report
            });

            console.log(`\nAdded comment to issue #${REPORT_ISSUE_NUMBER} with new report`);

name: Monthly Issue Report

on:
  schedule:
    # Run on the 1st of every month at 9:00 AM UTC
    - cron: "0 9 1 * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (print report without updating issue)'
        type: boolean
        default: false

jobs:
  generate-report:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.UI5_WEBCOMP_BOT_GH_TOKEN }}
          script: |
            const REPORT_ISSUE_NUMBER = 13080; // Monthly Issues Report tracking issue
            const isDryRun = context.eventName === 'workflow_dispatch' && ${{ inputs.dry_run || false }};

            // All TOPIC labels to track (team labels)
            const topics = [
              'TOPIC B',
              'TOPIC Core',
              'TOPIC P',
              'TOPIC RD',
              'TOPIC RL',
              'TOPIC SKR',
              'TOPIC TBL'
            ];

            // Helper to check if issue is a bug (by label OR issue type)
            const isBug = (issue) => {
              const labels = issue.labels.map(l => l.name.toLowerCase());
              const typeName = issue.type?.name?.toLowerCase() || '';
              return labels.includes('bug') || typeName === 'bug';
            };

            // Helper to check if issue is a feature request (by label OR issue type)
            const isFeatureRequest = (issue) => {
              const labels = issue.labels.map(l => l.name.toLowerCase());
              const typeName = issue.type?.name?.toLowerCase() || '';
              return labels.includes('feature request') || labels.includes('enhancement') || typeName === 'feature';
            };

            // Calculate date range for last month
            const now = new Date();
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
            const monthName = lastMonth.toLocaleString('en-US', { month: 'long', year: 'numeric' });

            const sinceDate = lastMonth.toISOString();
            const untilDate = lastMonthEnd.toISOString();

            console.log(`Generating report for ${monthName}`);
            console.log(`Date range: ${sinceDate} to ${untilDate}`);

            const results = [];

            for (const topic of topics) {
              // Get issues with this label using raw API to include 'type' field
              const allIssues = await github.paginate('GET /repos/{owner}/{repo}/issues', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: topic,
                state: 'all',
                since: sinceDate,
                per_page: 100
              });

              // Filter to issues created within the date range (exclude PRs)
              const opened = allIssues.filter(issue => {
                const created = new Date(issue.created_at);
                return created >= lastMonth && created <= lastMonthEnd && !issue.pull_request;
              });

              // Get closed issues - filter those closed in the period
              const closed = allIssues.filter(issue => {
                if (!issue.closed_at || issue.pull_request) return false;
                const closedDate = new Date(issue.closed_at);
                return closedDate >= lastMonth && closedDate <= lastMonthEnd;
              });

              // Split by type
              const openedBugs = opened.filter(isBug);
              const openedFRs = opened.filter(isFeatureRequest);
              const openedOther = opened.filter(i => !isBug(i) && !isFeatureRequest(i));

              const closedBugs = closed.filter(isBug);
              const closedFRs = closed.filter(isFeatureRequest);
              const closedOther = closed.filter(i => !isBug(i) && !isFeatureRequest(i));

              // Calculate stats (average and median) for time to close
              const calcStats = (issues) => {
                if (issues.length === 0) return { avg: null, median: null, days: [] };
                const days = issues.map(issue => {
                  const created = new Date(issue.created_at);
                  const closedDate = new Date(issue.closed_at);
                  return (closedDate - created) / (1000 * 60 * 60 * 24);
                });
                const sorted = [...days].sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                const median = sorted.length % 2 === 0
                  ? (sorted[mid - 1] + sorted[mid]) / 2
                  : sorted[mid];
                const avg = days.reduce((a, b) => a + b, 0) / days.length;
                return { avg: avg.toFixed(1), median: median.toFixed(1), days };
              };

              results.push({
                topic: topic,
                bugs: { opened: openedBugs.length, closed: closedBugs.length, ...calcStats(closedBugs) },
                frs: { opened: openedFRs.length, closed: closedFRs.length, ...calcStats(closedFRs) },
                other: { opened: openedOther.length, closed: closedOther.length, ...calcStats(closedOther) },
                total: { opened: opened.length, closed: closed.length, ...calcStats(closed) }
              });
            }

            // Build markdown report
            let report = `## ${monthName} Issue Report\n\n`;

            // Helper to format avg/median
            const formatTime = (avg, median) => {
              if (!avg) return '-';
              return `${avg} (${median})`;
            };

            // Bugs table
            report += `### Bugs\n\n`;
            report += `| Topic | Opened | Closed | Avg (Median) |\n`;
            report += `|-------|--------|--------|---------------|\n`;

            let totalBugsOpened = 0, totalBugsClosed = 0;
            let allBugsDays = [];
            for (const r of results) {
              const timeStr = formatTime(r.bugs.avg, r.bugs.median);
              report += `| ${r.topic} | ${r.bugs.opened} | ${r.bugs.closed} | ${timeStr} |\n`;
              totalBugsOpened += r.bugs.opened;
              totalBugsClosed += r.bugs.closed;
              allBugsDays = allBugsDays.concat(r.bugs.days || []);
            }
            const bugsTotalAvg = allBugsDays.length > 0 ? (allBugsDays.reduce((a, b) => a + b, 0) / allBugsDays.length).toFixed(1) : null;
            const bugsSorted = [...allBugsDays].sort((a, b) => a - b);
            const bugsMid = Math.floor(bugsSorted.length / 2);
            const bugsTotalMedian = bugsSorted.length > 0 ? (bugsSorted.length % 2 === 0 ? ((bugsSorted[bugsMid - 1] + bugsSorted[bugsMid]) / 2).toFixed(1) : bugsSorted[bugsMid].toFixed(1)) : null;
            report += `| **Total** | **${totalBugsOpened}** | **${totalBugsClosed}** | **${formatTime(bugsTotalAvg, bugsTotalMedian)}** |\n\n`;

            // Feature Requests table
            report += `### Feature Requests\n\n`;
            report += `| Topic | Opened | Closed | Avg (Median) |\n`;
            report += `|-------|--------|--------|---------------|\n`;

            let totalFRsOpened = 0, totalFRsClosed = 0;
            let allFRsDays = [];
            for (const r of results) {
              const timeStr = formatTime(r.frs.avg, r.frs.median);
              report += `| ${r.topic} | ${r.frs.opened} | ${r.frs.closed} | ${timeStr} |\n`;
              totalFRsOpened += r.frs.opened;
              totalFRsClosed += r.frs.closed;
              allFRsDays = allFRsDays.concat(r.frs.days || []);
            }
            const frsTotalAvg = allFRsDays.length > 0 ? (allFRsDays.reduce((a, b) => a + b, 0) / allFRsDays.length).toFixed(1) : null;
            const frsSorted = [...allFRsDays].sort((a, b) => a - b);
            const frsMid = Math.floor(frsSorted.length / 2);
            const frsTotalMedian = frsSorted.length > 0 ? (frsSorted.length % 2 === 0 ? ((frsSorted[frsMid - 1] + frsSorted[frsMid]) / 2).toFixed(1) : frsSorted[frsMid].toFixed(1)) : null;
            report += `| **Total** | **${totalFRsOpened}** | **${totalFRsClosed}** | **${formatTime(frsTotalAvg, frsTotalMedian)}** |\n\n`;

            // Other table
            report += `### Other\n\n`;
            report += `| Topic | Opened | Closed | Avg (Median) |\n`;
            report += `|-------|--------|--------|---------------|\n`;

            let totalOtherOpened = 0, totalOtherClosed = 0;
            let allOtherDays = [];
            for (const r of results) {
              const timeStr = formatTime(r.other.avg, r.other.median);
              report += `| ${r.topic} | ${r.other.opened} | ${r.other.closed} | ${timeStr} |\n`;
              totalOtherOpened += r.other.opened;
              totalOtherClosed += r.other.closed;
              allOtherDays = allOtherDays.concat(r.other.days || []);
            }
            const otherTotalAvg = allOtherDays.length > 0 ? (allOtherDays.reduce((a, b) => a + b, 0) / allOtherDays.length).toFixed(1) : null;
            const otherSorted = [...allOtherDays].sort((a, b) => a - b);
            const otherMid = Math.floor(otherSorted.length / 2);
            const otherTotalMedian = otherSorted.length > 0 ? (otherSorted.length % 2 === 0 ? ((otherSorted[otherMid - 1] + otherSorted[otherMid]) / 2).toFixed(1) : otherSorted[otherMid].toFixed(1)) : null;
            report += `| **Total** | **${totalOtherOpened}** | **${totalOtherClosed}** | **${formatTime(otherTotalAvg, otherTotalMedian)}** |\n\n`;

            // Summary
            report += `### Summary\n\n`;
            report += `| Type | Opened | Closed | Avg (Median) |\n`;
            report += `|------|--------|--------|---------------|\n`;
            report += `| Bugs | ${totalBugsOpened} | ${totalBugsClosed} | ${formatTime(bugsTotalAvg, bugsTotalMedian)} |\n`;
            report += `| Feature Requests | ${totalFRsOpened} | ${totalFRsClosed} | ${formatTime(frsTotalAvg, frsTotalMedian)} |\n`;
            report += `| Other | ${totalOtherOpened} | ${totalOtherClosed} | ${formatTime(otherTotalAvg, otherTotalMedian)} |\n`;
            const grandOpened = totalBugsOpened + totalFRsOpened + totalOtherOpened;
            const grandClosed = totalBugsClosed + totalFRsClosed + totalOtherClosed;
            const allDays = [...allBugsDays, ...allFRsDays, ...allOtherDays];
            const grandAvg = allDays.length > 0 ? (allDays.reduce((a, b) => a + b, 0) / allDays.length).toFixed(1) : null;
            const grandSorted = [...allDays].sort((a, b) => a - b);
            const grandMid = Math.floor(grandSorted.length / 2);
            const grandMedian = grandSorted.length > 0 ? (grandSorted.length % 2 === 0 ? ((grandSorted[grandMid - 1] + grandSorted[grandMid]) / 2).toFixed(1) : grandSorted[grandMid].toFixed(1)) : null;
            report += `| **Total** | **${grandOpened}** | **${grandClosed}** | **${formatTime(grandAvg, grandMedian)}** |\n`;

            report += `\n_Report generated: ${now.toISOString()}_\n`;

            console.log('\n' + report);

            if (isDryRun) {
              console.log('\nDry run - not updating issue');
              return;
            }

            if (REPORT_ISSUE_NUMBER === 0) {
              console.log('\nREPORT_ISSUE_NUMBER not set - skipping issue update');
              console.log('Create a tracking issue and set REPORT_ISSUE_NUMBER to its number');
              return;
            }

            // Add report as a comment on the tracking issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: REPORT_ISSUE_NUMBER,
              body: report
            });

            console.log(`\nAdded comment to issue #${REPORT_ISSUE_NUMBER} with new report`);
